<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Ray.js example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <style>
body {
  overflow: hidden;
  margin: 0;
  padding: 0;
}
canvas {
}
    </style>

    <body>

      <script src="node_modules/three/build/three.js"></script>
      <script src="node_modules/three/examples/js/controls/VRControls.js"></script>
      <script src="node_modules/three/examples/js/effects/VREffect.js"></script>
      <script src="build/example.js"></script>


<script src="http://127.0.0.1:3000/socket.io/socket.io.js"></script>
<script>
;(function(){
        
var socket = io('http://127.0.0.1:3000');
// general spec for Gamepad API - https://www.w3.org/TR/gamepad/
var gamepad = {
	'id' : 'PhoneAsGamepad.js controller',
	'index' : 0,
	'connected' : true,
	'mapping' : 'standard',
	'axes' : [],
	'buttons' : [{
		'pressed' : false,
		'touched' : false,
		'value' : 0,
	}, {
		'pressed' : false,
		'touched' : false,
		'value' : 0,		
	}],
	// VR extension - https://w3c.github.io/gamepad/extensions.html#dom-gamepadpose
	'pose' : {
		'hasPosition' : false,
		'hasOrientation' : true,
		
		'position' : null,
		'linearVelocity' : null,
		'linearAcceleration' : null,
		
		'orientation' : [0,0,0,1],
		'angularVelocity' : null,
		'angularAcceleration' : null
	}
}
window.myGamepad = gamepad
var first = null
socket.on('broadcast', function(message){
        // console.log('received', message)
// return        
	var event = JSON.parse(message)
	if( event.type === 'deviceOrientation' ){
                // console.log('broadcast', message)
		if( first === null ){
			first = {
				alpha: event.alpha,
				beta: event.beta,
				gamma: event.gamma
			}
			console.log('init first', first)
                        return
		}else{
			var alpha = event.alpha-first.alpha
                        var beta = event.beta-first.beta
                        var gamma = event.gamma-first.gamma
		}
		var euler = new THREE.Euler()
		euler.x =  beta  / 180 * Math.PI
		euler.y =  alpha / 180 * Math.PI
		euler.z = -gamma / 180 * Math.PI
		euler.order = "YXZ"
		
		var quaternion = new THREE.Quaternion()
		quaternion.setFromEuler(euler)
                quaternion.toArray(gamepad.pose.orientation)
	}else if( event.type === 'touchstart' ){
		if( event.target === 'button1' ){
			gamepad.buttons[0].pressed = true
			gamepad.buttons[0].value = 1
		}else if( event.target === 'button2' ){
			gamepad.buttons[1].pressed = true
			gamepad.buttons[1].value = 1
		}else{
			console.assert(false)
		}
	}else if( event.type === 'touchend' ){
		if( event.target === 'button1' ){
			gamepad.buttons[0].pressed = false
			gamepad.buttons[0].value = 0
		}else if( event.target === 'button2' ){
			gamepad.buttons[1].pressed = false
			gamepad.buttons[1].value = 0
		}else{
			console.assert(false)
		}

	}else {
		console.assert(false)
	}
})
})()

</script>
</body>
</html>
